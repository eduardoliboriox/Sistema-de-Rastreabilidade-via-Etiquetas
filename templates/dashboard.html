{% extends "base.html" %}
{% block title %}Dashboard de ProduÃ§Ã£o{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">

    <!-- CabeÃ§alho -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="fw-bold text-primary mb-0">ðŸ“Š Dashboard de ProduÃ§Ã£o</h2>
        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('PTH')">PTH</button>
            <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('SMT')">SMT</button>
            <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('IM')">IM</button>
            <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('PA')">PA</button>
            <button class="btn btn-outline-dark btn-sm fw-bold btn-setor" onclick="filterBySetor('ESTOQUE')">Estoque</button>
            <button class="btn btn-outline-secondary btn-sm fw-bold btn-setor" onclick="filterBySetor('TODOS')">Mostrar Todos</button>
        </div>
    </div>

    <!-- Filtros de status -->
    <div class="d-flex justify-content-start flex-wrap gap-2 mb-4">
        <button class="btn btn-outline-warning btn-sm fw-bold btn-status" onclick="filterByStatus('AGUARDANDO')">ðŸ•“ Aguardando</button>
        <button class="btn btn-outline-success btn-sm fw-bold btn-status" onclick="filterByStatus('DISPONIVEL')">âœ… DisponÃ­vel</button>
        <button class="btn btn-outline-info btn-sm fw-bold btn-status" onclick="filterByStatus('EXPEDIDO')">ðŸ“¦ Expedido</button>
        <button class="btn btn-outline-secondary btn-sm fw-bold btn-status" onclick="filterByStatus('TODOS')">Mostrar Todos</button>
    </div>

    <!-- TOTAL GERAL -->
    <div class="alert alert-primary fw-bold mb-3" id="totalGeralBox">
        Total Geral: 0
    </div>

    <!-- Tabela -->
    <div class="table-responsive shadow-sm rounded-4 bg-light p-3">
        <table class="table table-hover table-bordered align-middle" id="dashboardTable">
            <thead class="table-primary text-center">
                <tr>
                    <th>Modelo</th>
                    <th>CÃ³digo</th>
                    <th>Setor</th>
                    <th>Fase</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data %}
                    {% for saldo in item.saldo_setores %}
                    <tr class="text-center" 
                        data-setor="{{ saldo.setor }}"
                        data-status="{{ saldo.status }}">
                        <td class="fw-bold">{{ item.model.model_name }}</td>
                        <td>{{ item.model.code }}</td>
                        <td>{{ saldo.setor }}</td>
                        <td>
                            {% if saldo.status == "AGUARDANDO" %}
                                <span class="badge bg-warning text-dark">{{ saldo.fase }}</span>
                            {% elif saldo.status == "DISPONIVEL" %}
                                <span class="badge bg-success">{{ saldo.fase }}</span>
                            {% elif saldo.status == "EXPEDIDO" %}
                                <span class="badge bg-info text-dark">{{ saldo.fase }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ saldo.fase }}</span>
                            {% endif %}
                        </td>
                        <td class="fw-semibold">{{ saldo.saldo }}</td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
let currentSetor = 'TODOS';
let currentStatus = 'TODOS';

const getRows = () => Array.from(document.querySelectorAll('#dashboardTable tbody tr'));

function applyFilters() {
    const rows = getRows();
    rows.forEach(row => {
        const rowSetor = (row.dataset.setor || 'SEM SETOR').toString().trim();
        const rowStatus = (row.dataset.status || '').toString().trim();
        const okSetor = (currentSetor === 'TODOS') || (rowSetor === currentSetor);
        const okStatus = (currentStatus === 'TODOS') || (rowStatus === currentStatus);
        row.style.display = (okSetor && okStatus) ? '' : 'none';
    });
    calcularTotalGeral();
}

function setActiveSetorBtn(setor) {
    document.querySelectorAll('.btn-setor').forEach(btn => btn.classList.remove('active'));
    const clicked = document.querySelector(`[onclick="filterBySetor('${setor}')"]`);
    if (clicked) clicked.classList.add('active');
}

function setActiveStatusBtn(status) {
    document.querySelectorAll('.btn-status').forEach(btn => btn.classList.remove('active'));
    const clicked = document.querySelector(`[onclick="filterByStatus('${status}')"]`);
    if (clicked) clicked.classList.add('active');
}

function filterBySetor(setor) {
    currentSetor = setor;
    setActiveSetorBtn(setor);
    applyFilters();
}

function filterByStatus(status) {
    currentStatus = status;
    setActiveStatusBtn(status);
    applyFilters();
}

function calcularTotalGeral() {
    let total = 0;
    getRows().forEach(row => {
        if (row.style.display !== 'none') {
            const saldo = parseInt(row.querySelector('td:nth-child(5)').innerText) || 0;
            total += saldo;
        }
    });
    document.getElementById("totalGeralBox").innerText = "Total Geral: " + total;
}

document.addEventListener('DOMContentLoaded', () => {
    setActiveSetorBtn('TODOS');
    setActiveStatusBtn('TODOS');
    applyFilters();
});
</script>
{% endblock %}
